---
import Layout from "@/layouts/Layout.astro";
import UserNavbar from "@/components/UserNavbar.astro";
import UsernameModal from "@/components/UsernameModal.astro";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import { serializeBlockchainLogos } from "@/utils/blockchain-logos";
import hiveLogo from "@/assets/hive-logo-con.svg";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get username from URL params
const url = new URL(Astro.request.url);
const username = url.searchParams.get("user") || "";

// Serialize logos for client-side usage
const blockchainLogosJson = serializeBlockchainLogos();
---

<Layout
  title={`${t("fees.pageTitle")} - Ops by Hive`}
  description={t("fees.pageDescription")}
>
  <UserNavbar />

  <div
    class="min-h-screen w-full pt-16 md:pt-24 pb-8 md:pb-12 px-4 md:px-8 overflow-x-hidden flex items-center justify-center"
    data-blockchain-logos={blockchainLogosJson}
  >
    <div class="max-w-md mx-auto w-full">
      <!-- Hero Section -->
      <div class="text-center mb-8" id="hero">
        <h1 class="text-4xl md:text-5xl font-black mb-3 tracking-tight">
          {t("fees.heroTitle")}
        </h1>
        <p class="text-sm md:text-base text-white/60 max-w-md mx-auto">
          {t("fees.heroDescription")}
        </p>
      </div>

      <!-- Share Card Section -->
      <div class="w-full" id="shareSection">
        <!-- Share Button -->
        <div class="flex justify-end mb-4 relative">
          <button
            id="shareBtn"
            class="group relative flex items-center gap-2 px-4 py-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 hover:border-red-500/50 rounded-xl transition-all duration-300 hover:shadow-[0_0_20px_rgba(227,19,55,0.3)]"
            title={t("user.share")}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5 text-red-500 transition-transform group-hover:scale-110"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
              ></path>
            </svg>
            <span class="font-sans text-sm font-medium text-white/90">
              {t("user.share")}
            </span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4 text-red-500 transition-transform duration-200"
              id="dropdownIcon"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <!-- Dropdown Menu -->
          <div
            id="shareMenu"
            class="hidden absolute right-0 top-full mt-2 w-56 bg-black/95 backdrop-blur-sm border border-red-500/30 rounded-xl shadow-[0_0_30px_rgba(227,19,55,0.2)] overflow-hidden z-50"
          >
            <button
              id="copyBtn"
              class="w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-red-500/10 transition-colors duration-200 border-b border-red-500/20"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5 text-red-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                ></path>
              </svg>
              <div>
                <p class="font-sans text-sm font-medium text-white">
                  {t("user.copyImage")}
                </p>
                <p class="font-sans text-xs text-white/60">
                  {t("user.copyImageDesc")}
                </p>
              </div>
            </button>

            <button
              id="downloadBtn"
              class="w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-red-500/10 transition-colors duration-200"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5 text-red-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                ></path>
              </svg>
              <div>
                <p class="font-sans text-sm font-medium text-white">
                  {t("user.downloadImage")}
                </p>
                <p class="font-sans text-xs text-white/60">
                  {t("user.downloadImageDesc")}
                </p>
              </div>
            </button>
          </div>
        </div>

        <!-- Stats Card with 4:5 aspect ratio (same as user.astro) -->
        <div
          id="statsCard"
          class="relative bg-black p-0"
          style="aspect-ratio: 4/5;"
        >
          <div
            class="absolute inset-0 bg-linear-to-br from-transparent via-red-500/10 to-transparent pointer-events-none"
          >
          </div>

          <div
            class="relative overflow-hidden p-6 md:p-8 border border-red-500/30 shadow-[0_0_60px_rgba(227,19,55,0.2)] flex h-full"
          >
            <div
              class="absolute inset-0 bg-linear-to-tr from-red-500/5 via-transparent to-red-500/5 pointer-events-none"
            >
            </div>

            <!-- Content -->
            <div
              class="relative z-10 flex flex-col justify-between h-full w-full py-2"
            >
              <div class="space-y-2">
                <!-- Username -->
                <div class="text-center relative">
                  <kbd
                    class="absolute left-0 top-0 px-2 py-0.5 text-[clamp(0.5rem,1.4vw,0.65rem)] font-mono font-semibold text-white/40 bg-white/5 border border-white/10 rounded shadow-sm"
                  >
                    wallet
                  </kbd>
                  <h2
                    class="font-sans text-[clamp(1.1rem,3.5vw,1.8rem)] font-black text-red-500 break-words opacity-0 m-0 tracking-tight"
                    id="usernameDisplay"
                  >
                    @{username || "..."}
                  </h2>
                </div>

                <!-- Total Operations on Hive -->
                <div class="text-center">
                  <p
                    class="font-sans text-[clamp(0.6rem,1.5vw,0.75rem)] text-white/60 mb-0.5 font-medium"
                  >
                    {t("fees.totalOperations")}
                  </p>
                  <p
                    class="font-sans text-[clamp(1rem,3vw,1.5rem)] font-black opacity-0 m-0 leading-none tracking-tight"
                    id="operationsCountCard"
                  >
                    0
                  </p>
                </div>

                <!-- Fees on Hive -->
                <div class="text-center">
                  <div
                    class="flex items-center justify-center gap-1.5 mt-4 mb-1"
                  >
                    <p
                      class="font-sans text-[clamp(0.65rem,1.7vw,0.85rem)] text-white/60 font-medium"
                    >
                      Fee on
                    </p>
                    <img
                      src={hiveLogo.src}
                      alt="Hive"
                      class="w-[clamp(0.85rem,2.2vw,1.1rem)] h-[clamp(0.85rem,2.2vw,1.1rem)]"
                    />
                    <p
                      class="font-sans text-[clamp(0.65rem,1.7vw,0.85rem)] text-white/90 font-bold uppercase tracking-wide"
                    >
                      Hive
                    </p>
                  </div>
                  <p
                    class="font-sans text-[clamp(1.6rem,5vw,2.5rem)] font-black text-green-500 m-0 leading-none tracking-tight"
                  >
                    $0
                  </p>
                </div>

                <!-- Divider -->
                <div
                  class="h-px bg-linear-to-r from-transparent via-white/20 to-transparent my-8"
                >
                </div>

                <!-- Blockchain Comparisons -->
                <div>
                  <p
                    class="font-sans text-[clamp(0.6rem,1.5vw,0.75rem)] text-white/60 mb-1.5 text-center font-medium"
                  >
                    {t("fees.wouldHaveSpent")}
                  </p>
                  <div class="space-y-1" id="statsCardBlockchains">
                    <!-- Blockchain items will be inserted here -->
                  </div>
                </div>
              </div>

              <!-- Bottom Section - Branding -->
              <div class="space-y-1.5">
                <!-- Divider -->
                <div
                  class="h-px bg-linear-to-r from-transparent via-white/20 to-transparent"
                >
                </div>

                <div
                  class="text-center flex items-center justify-center gap-1.5"
                >
                  <img
                    src={hiveLogo.src}
                    alt="Hive"
                    class="w-[clamp(0.65rem,1.7vw,0.85rem)] h-[clamp(0.65rem,1.7vw,0.85rem)]"
                  />
                  <p
                    class="font-sans text-[clamp(0.5rem,1.3vw,0.6rem)] text-white/30 uppercase tracking-widest font-medium"
                  >
                    Ops by Hive
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <UsernameModal />
</Layout>

<style>
  @keyframes fadeInLeft {
    from {
      opacity: 0;
      transform: translateX(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>

<script>
  import {
    calculateFeeComparisonDefault,
    formatFeeComparisonResult,
    formatTotalSavings,
    formatLargeNumber,
    BLOCKCHAIN_SYMBOLS,
    type FormattedFeeComparison,
    BlockchainNetwork,
  } from "@/utils/fee-calculator";
  import { gsap } from "gsap";
  import { animateCounterInElement } from "@/utils/animations";
  import {
    captureElementAsImage,
    copyImageToClipboard,
    downloadImage,
    ImageFormat,
  } from "@/utils/imageCapture";
  import { getLangFromUrl, useTranslations } from "@/i18n/utils";

  const lang = getLangFromUrl(new URL(window.location.href));
  const t = useTranslations(lang);

  // Get username from URL
  const urlParams = new URLSearchParams(window.location.search);
  const username = urlParams.get("user");

  if (!username) {
    window.location.href = "/";
  }

  // Load blockchain logos from data attribute
  const blockchainLogosData = document.querySelector("[data-blockchain-logos]");
  const blockchainLogos: Record<BlockchainNetwork, string> = blockchainLogosData
    ? JSON.parse(
        blockchainLogosData.getAttribute("data-blockchain-logos") || "{}"
      )
    : {};

  // Fetch user operations from Hive API
  async function fetchUserOperations(username: string): Promise<number> {
    try {
      const response = await fetch(
        `https://api.syncad.com/hafah-api/accounts/${username}/operations?participation-mode=all&page-size=100&data-size-limit=200000`
      );

      if (!response.ok) {
        throw new Error(`API request failed: ${response.status}`);
      }

      const data = await response.json();
      return data.total_operations || 0;
    } catch (error) {
      console.error("Error fetching user operations:", error);
      return 0;
    }
  }

  // Render blockchain items in stats card
  function renderStatsCardBlockchains(results: FormattedFeeComparison[]) {
    const container = document.getElementById("statsCardBlockchains");
    if (!container) {
      console.error("Container #statsCardBlockchains not found");
      return;
    }

    console.log("Rendering blockchain items:", results);

    container.innerHTML = results
      .map((result, index) => {
        const logoUrl = blockchainLogos[result.blockchain];
        const symbol = BLOCKCHAIN_SYMBOLS[result.blockchain];
        const logoHtml = logoUrl
          ? `<img src="${logoUrl}" alt="${result.blockchainDisplayName}" class="w-[clamp(0.75rem,2vw,1rem)] h-[clamp(0.75rem,2vw,1rem)] flex-shrink-0" />`
          : "";

        const delay = index * 100; // 100ms delay between each item

        return `
          <div class="blockchain-item opacity-0 flex items-center justify-between gap-1.5 py-1" style="animation: fadeInLeft 0.4s ease-out forwards; animation-delay: ${delay}ms;">
            <div class="flex items-center gap-1.5 flex-shrink-0">
              ${logoHtml}
              <span class="font-sans text-[clamp(0.65rem,1.6vw,0.8rem)] font-semibold text-white/90">${result.blockchainDisplayName}</span>
              <span class="font-sans text-[clamp(0.55rem,1.4vw,0.65rem)] text-white/40 font-medium">(${symbol})</span>
            </div>
            <div class="flex-1 border-b border-dotted border-white/20 mx-1.5 min-w-[0.5rem]"></div>
            <span class="font-sans text-[clamp(0.7rem,1.8vw,0.85rem)] font-bold text-red-500 tabular-nums tracking-tight whitespace-nowrap flex-shrink-0">${result.totalFeeFormatted}</span>
          </div>
        `;
      })
      .join("");

    console.log("Blockchain items rendered, count:", container.children.length);
  }

  // Create GSAP timeline with animations
  function createMasterTimeline(
    totalOperations: number,
    totalSavingsFormatted: string
  ) {
    const tl = gsap.timeline();

    // Step 1: Hero fade in
    tl.from(
      "#hero h1",
      {
        opacity: 0,
        y: 40,
        duration: 0.8,
        ease: "power3.out",
      },
      0
    );

    // Step 2: Hero description
    tl.from(
      "#hero p",
      {
        opacity: 0,
        y: 20,
        duration: 0.6,
        ease: "power2.out",
      },
      0.3
    );

    // Step 3: Share section appears
    tl.from(
      "#shareSection",
      {
        opacity: 0,
        y: 30,
        duration: 0.7,
        ease: "power2.out",
      },
      0.6
    );

    // Step 4: Username display
    tl.to(
      "#usernameDisplay",
      {
        opacity: 1,
        scale: 1,
        duration: 0.5,
        ease: "back.out(1.7)",
      },
      1.0
    );

    // Step 5: Total savings box scale in
    tl.to(
      "#totalSavings",
      {
        opacity: 1,
        scale: 1,
        duration: 0.8,
        ease: "back.out(1.7)",
      },
      1.3
    );

    // Step 6: Total savings counter
    tl.add(() => {
      const savingsElement = document.getElementById("totalSavings");
      if (savingsElement) {
        const numericValue = parseFloat(
          totalSavingsFormatted.replace(/[$,]/g, "")
        );
        const counter = { value: 0 };
        gsap.to(counter, {
          value: numericValue,
          duration: 2,
          ease: "power2.out",
          onUpdate: () => {
            savingsElement.textContent = `$${Math.floor(counter.value).toLocaleString("en-US")}`;
          },
          onComplete: () => {
            savingsElement.textContent = totalSavingsFormatted;
          },
        });
      }
    }, 1.5);

    // Step 7: Operations counter in card
    tl.add(() => {
      const opsElement = document.getElementById("operationsCountCard");
      if (opsElement) {
        gsap.to(opsElement, { opacity: 1, duration: 0.3 });
        animateCounterInElement(opsElement, totalOperations, {
          duration: 2,
          ease: "power2.out",
          onUpdate: (value) => {
            opsElement.textContent = formatLargeNumber(value);
          },
        });
      }
    }, 1.5);

    return tl;
  }

  // Share dropdown toggle handlers
  const shareBtn = document.getElementById("shareBtn");
  const shareMenu = document.getElementById("shareMenu");
  const dropdownIcon = document.getElementById("dropdownIcon");

  // Toggle dropdown menu
  shareBtn?.addEventListener("click", (e) => {
    e.stopPropagation();
    shareMenu?.classList.toggle("hidden");
    dropdownIcon?.classList.toggle("rotate-180");
  });

  // Close dropdown when clicking outside
  document.addEventListener("click", (e) => {
    if (!shareBtn?.contains(e.target as Node)) {
      shareMenu?.classList.add("hidden");
      dropdownIcon?.classList.remove("rotate-180");
    }
  });

  // Copy button handler
  async function handleCopy() {
    const statsCard = document.getElementById("statsCard");
    const copyBtn = document.getElementById("copyBtn");
    if (!statsCard || !copyBtn) return;

    try {
      const btnText = copyBtn.querySelector("p");
      const originalText = btnText?.textContent || t("user.copyImage");
      if (btnText) btnText.textContent = t("user.copying");

      // Capture image
      const capture = await captureElementAsImage(statsCard, {
        format: ImageFormat.PNG,
        quality: 1.0,
        scale: 2,
      });

      // Copy to clipboard
      const result = await copyImageToClipboard(capture.blob);

      // Update UI
      if (btnText) {
        btnText.textContent = result.success
          ? t("user.copied")
          : t("user.unsupported");
        setTimeout(() => {
          btnText.textContent = originalText;
          shareMenu?.classList.add("hidden");
          dropdownIcon?.classList.remove("rotate-180");
        }, 2000);
      }
    } catch (error) {
      console.error("Copy failed:", error);
      const btnText = copyBtn.querySelector("p");
      if (btnText) {
        btnText.textContent = t("user.error");
        setTimeout(() => {
          btnText.textContent = t("user.copyImage");
        }, 2000);
      }
    }
  }

  // Download button handler
  async function handleDownload() {
    const statsCard = document.getElementById("statsCard");
    const downloadBtn = document.getElementById("downloadBtn");
    if (!statsCard || !downloadBtn || !username) return;

    try {
      const btnText = downloadBtn.querySelector("p");
      const originalText = btnText?.textContent || t("user.downloadImage");
      if (btnText) btnText.textContent = t("user.downloading");

      // Capture image
      const capture = await captureElementAsImage(statsCard, {
        format: ImageFormat.JPEG,
        quality: 0.95,
        scale: 2,
      });

      // Download
      const result = await downloadImage(
        capture.blob,
        `hive-fees-${username}`,
        ImageFormat.JPEG
      );

      // Update UI
      if (btnText) {
        btnText.textContent = result.success
          ? t("user.downloaded")
          : t("user.error");
        setTimeout(() => {
          btnText.textContent = originalText;
          shareMenu?.classList.add("hidden");
          dropdownIcon?.classList.remove("rotate-180");
        }, 2000);
      }
    } catch (error) {
      console.error("Download failed:", error);
      const btnText = downloadBtn.querySelector("p");
      if (btnText) {
        btnText.textContent = t("user.error");
        setTimeout(() => {
          btnText.textContent = t("user.downloadImage");
        }, 2000);
      }
    }
  }

  // Main execution
  async function main() {
    if (!username) return;

    console.log("Starting main with username:", username);

    // Update username display
    const usernameDisplay = document.getElementById("usernameDisplay");
    if (usernameDisplay) {
      usernameDisplay.textContent = `@${username}`;
    }

    // Fetch operations count
    const totalOperations = await fetchUserOperations(username);
    console.log("Total operations:", totalOperations);

    // Calculate fee comparison
    const comparisonResult = calculateFeeComparisonDefault(totalOperations);
    const formattedResults = formatFeeComparisonResult(comparisonResult);
    const totalSavingsFormatted = formatTotalSavings(comparisonResult);

    console.log("Formatted results:", formattedResults);
    console.log("Total savings:", totalSavingsFormatted);

    // Render blockchain items in stats card
    renderStatsCardBlockchains(formattedResults);

    // Wait for DOM to update before starting animations
    requestAnimationFrame(() => {
      // Create and play master animation timeline
      createMasterTimeline(totalOperations, totalSavingsFormatted);
    });

    // Attach button handlers
    const copyBtn = document.getElementById("copyBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    if (copyBtn) copyBtn.addEventListener("click", handleCopy);
    if (downloadBtn) downloadBtn.addEventListener("click", handleDownload);
  }

  // Execute on page load
  main();
</script>
